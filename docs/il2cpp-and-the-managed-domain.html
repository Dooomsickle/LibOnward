<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-03-19T20:46:14.0674134"><title>IL2CPP and the Managed Domain | Onward-Docs</title><script type="application/json" id="virtual-toc-data">[{"id":"il2cppinterop","level":0,"title":"Il2CppInterop","anchor":"#il2cppinterop"},{"id":"basics","level":0,"title":"Basics","anchor":"#basics"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.css" rel="stylesheet"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="IL2CPP and the Managed Domain | Onward-Docs"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Onward-Docs Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/69/1/il2cpp-and-the-managed-domain.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="IL2CPP and the Managed Domain | Onward-Docs"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/69/1/il2cpp-and-the-managed-domain.html#webpage",
    "url": "writerside-documentation/69/1/il2cpp-and-the-managed-domain.html",
    "name": "IL2CPP and the Managed Domain | Onward-Docs",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/69/#website",
    "url": "writerside-documentation/69/",
    "name": "Onward-Docs Help"
}</script><!-- End Schema.org --></head><body data-id="IL2CPP-and-The-Managed-Domain" data-main-title="IL2CPP and the Managed Domain" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Onward-Docs 1 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="IL2CPP-and-The-Managed-Domain" id="IL2CPP-and-The-Managed-Domain.md">IL2CPP and the Managed Domain</h1><p id="v3wgby_1436">Unity's IL2CPP backend first compiles all the .NET IL of your game to C++, then compiles that C++ to machine code. This brings massive performance benefits, as you could imagine. However, when modding it requires an entirely different approach to the running of code and the way objects are handled.</p><section class="chapter"><h2 id="il2cppinterop" data-toc="il2cppinterop">Il2CppInterop</h2><p id="v3wgby_1437">Il2CppInterop is the library used by MelonLoader to interoperate managed code with the IL2CPP code in memory. It generates a set of proxy .NET assemblies that allow us to create and manage objects from C# code.</p><p id="v3wgby_1438">It has features like array type wrappers, delegate conversion (managed -&gt; il2cpp), etc etc.</p></section><section class="chapter"><h2 id="basics" data-toc="basics">Basics</h2><p id="v3wgby_1439">IL2CPP objects in the managed domain are just wrappers.</p><p id="v3wgby_1440">The structure of IL2CPP objects (in memory) are pretty much identical to their managed counterparts. After all, they're just native versions of what they'd be in IL.</p><p id="v3wgby_1441">Every class definition of Il2CppInterop-generated assemblies has a setup like the following:</p><figure id="v3wgby_1442"><img alt="il2cpp class structure" src="images/class_structure.png" title="il2cpp class structure" width="468" height="562"></figure><aside class="prompt" data-type="note" data-title="" id="v3wgby_1443"><p>You can use DnSpy (find on GitHub) to decompile the generated assemblies in Onward/MelonLoader/Il2CppAssemblies.</p></aside><p id="v3wgby_1444">Let's analyze this.</p><ul class="list _bullet" id="v3wgby_1445"><li class="list__item" id="v3wgby_1446"><p>The teal functions under the class are constructors. The &quot;.cctor()&quot; is a static constructor that fills in the classes' pointers, while the other two actually make an object. Notice that one of the constructors takes an IntPtr (void* for c++ nerds) as an argument; this is what actually creates the object in the IL2CPP runtime by calling <code class="code" id="v3wgby_1447">il2cpp_object_new</code> with the classes' native pointer. </p><figure id="v3wgby_1448"><img alt="Ctors" src="images/ctors.png" title="Ctors" width="798" height="226"></figure></li><li class="list__item" id="v3wgby_1449"><p>The orange functions denote actual methods. When called, it takes the pointer to the native method (see purple fields) along with the pointer of the object and makes an internal call to <code class="code" id="v3wgby_1450">il2cpp_runtime_invoke</code>. That call returns another pointer to the return value (if it isn't void) and returns it dereferenced. </p><figure id="v3wgby_1451"><img alt="Methods" src="images/methods.png" title="Methods" width="798" height="226"></figure></li><li class="list__item" id="v3wgby_1452"><p>The dark-greenish members can represent either properties or fields. When accessed they take the base pointer of the object and add the offset of the field; then dereference that afterward. </p><figure id="v3wgby_1453"><img alt="Fields" src="images/fields.png" title="Fields" width="798" height="226"></figure></li><li class="list__item" id="v3wgby_1454"><p>Finally, the purplish-gray members represent pointers to the other members such as fields and methods. These get filled in by the .cctor when the class is loaded into memory.</p></li></ul><p id="v3wgby_1455">Every IL2CPP type derives from the class Il2CppSystem.Object, just like how managed ones derive from System.Object.</p><p id="v3wgby_1456">However, IL2CPP types can not be used as managed types and vice versa.</p><p id="v3wgby_1457">With our new knowledge of IL2CPP, let's now learn how to function hook with Harmony.</p></section><div class="last-modified">Last modified: 20 March 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="introduction.html" class="navigation-links__prev">Introduction</a><a href="harmony.html" class="navigation-links__next">Harmony</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.js"></script></body></html>